---
title: "4. Downscaling climate data"

output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{4. Downscaling climate data} 
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r global_options, include=FALSE}
library(knitr)
opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE, eval = FALSE)
```

This file is to document the downscaling process of Trace-21ka paleoclimate data using the most updated and finer resolution "historical" climate data for the Western Mediterranean region and the methods and tools implemented in the `climate4R` framework.

## Downscaling

### Defining variables and folds for crossvalidation
```{r load_packages_and_parameters`}
library(dsclim)
library(downscaleR)
vars <- c("tas", "tasmin", "tasmax", "hurs@992.5561", "ps",
          "pr", "cld", "wss")

spatial.pars <- list(which.combine = vars,
                        v.exp = .95,
                        rot = FALSE)

family.link <- gaussian(link="identity")

global.nc.attributes = list("author" = "Diego Nieto Lugilde & Daniel Romera Romera", "institution" = "Universidad de Cordoba", "email" = "bv2nilud@uco.es")
```

```{r load_data}
trace.file.names <- traceFileNames("../../Data/TraCE21ka/")
hist.trace <- dsclim::loadHistoricalTraceGrids(trace.file.names)

uerra = loadUerra("../../Data/UERRA/MESCAN-SURFEX/total_precipitation/latlon/1961-90_total_precipitation.nc", "pr")
uerra_bin = transformeR::binaryGrid(uerra, condition = "GE", threshold = 1)
```

```{r prepare_data}
data = prepareData(hist.trace, uerra, spatial.predictors = spatial.pars)
data_bin = prepareData(hist.trace, uerra_bin, spatial.predictors = spatial.pars)
```

```{r calibrate_model}
model_bin = downscaleTrain(data_bin, method = "GLM", family = binomial(link="logit"), predict = TRUE)
model = downscaleTrain(data, method = "GLM", family = family.link, predict = TRUE)
```

```{r downscale_single_trace_file}
downscaleTrace(1 , "output/", "../../Data/TraCE21ka/", mod_data = data, model = model, model_bin = model_bin, global_nc_attributes = global.nc.attributes)
```

```{r downscale_all_trace_files} 
lapply(1:36, downscaleTrace, "prueba/", "../../Data/TraCE21ka/", hist_trace = hist.trace, mod_data = data, model = model, global_nc_attributes = global.nc.attributes)
```

```{r downscale_cmip5_files}
cmip5.rcps <- c("rcp2.6", "rcp4.5", "rcp6.0", "rcp8.5")
cmip5.mods <- c("CESM1-CAM5", "CSIRO-Mk3-6-0", "IPSL-CM5A-MR")
spatial.pars <- list(which.combine = c("tas", "tasmax", "tasmin", "hurs", "ps", "pr", "cld", "wss"),
                     v.exp = .7,
                     rot = FALSE)

dowscaleCMIP5(uerra, cmip5.rcps[[1]], cmip5.mods[[1]], indir = "../../Data/CMIP5/", outdir = "prueba/CMIP5/", local.var, spatial.pars = spatial.pars, method = "GLM", family.link, global.nc.attributes)

new.cmip5.pred = target(
  downscaleCMIP5(uerra, cmip5.vars, cmip5.new.vars, rcp = rcp, mod = mod, cmip5.lon, cmip5.lat, "../../Data/CMIP5/dictionary.dic", "../../Data/CMIP5/", "../../Output/CMIP5/", local.var = "tasmin", spatial.pars = , method = "GLM", family.link, global.nc.attributes),
  transform = cross(
    rcp = !!cmip5.rcps,
    mod = !!cmip5.mods
  )
)
```

<!-- ![Bias summary histograms](figures/a3/a3_val_summary_histograms.png) -->
